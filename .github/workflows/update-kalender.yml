name: Update Hari Libur Nasional

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 1 *"  # Setiap 1 Januari jam 07:00 WIB (UTC)

env:
  CALENDAR_ID: id.indonesian%23holiday@group.v.calendar.google.com  # '#' harus di-encode sebagai %23

jobs:
  update-libur:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          pip install hijri-converter ephem lunardate pytz

      - name: Generate hari libur dari Google Calendar atau fallback ke script
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          mkdir -p data
          THIS_YEAR=$(date +%Y)
          NEXT_YEAR=$(($THIS_YEAR + 1))

          for YEAR in $THIS_YEAR $NEXT_YEAR; do
            echo "ðŸ“… Memproses tahun $YEAR..."
            TIME_MIN="${YEAR}-01-01T00:00:00Z"
            TIME_MAX="${YEAR}-12-31T23:59:59Z"
            FILE="data/${YEAR}.json"

            URL="https://www.googleapis.com/calendar/v3/calendars/${CALENDAR_ID}/events?key=${GOOGLE_API_KEY}&timeMin=${TIME_MIN}&timeMax=${TIME_MAX}&orderBy=startTime&singleEvents=true"

            echo "ðŸŒ Fetching from: $URL"
            RESPONSE=$(curl -s "$URL")
            ITEMS=$(echo "$RESPONSE" | jq '.items // []')

            if [ "$ITEMS" = "[]" ]; then
              echo "âš ï¸  Google Calendar kosong. Gunakan fallback script Python: script/python.py"
              if [ -f script/python.py ]; then
                python3 script/python.py "$YEAR"
              else
                echo "âŒ Fallback script tidak ditemukan: script/python.py"
                exit 1
              fi
            else
              echo "$ITEMS" | jq '[.[] | {Keterangan: .summary, Tanggal: .start.date}]' > "$FILE"
              echo "âœ… Disimpan ke $FILE dari Google Calendar"
            fi
          done

      - name: Commit dan Push hasil
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ”„ Update otomatis hari libur nasional dari Google Calendar"
          branch: main
          file_pattern: 'data/*.json'
