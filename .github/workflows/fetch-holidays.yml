name: Fetch Hari Libur Nasional

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1' # Setiap Senin 00:00 UTC

jobs:
  fetch-holidays:
    runs-on: ubuntu-latest

    env:
      NEXT_YEAR: ${{ github.event.inputs.year || format('{0}', fromJson('"' + github.event.schedule + '"') && (fromJson('"' + github.event.schedule + '"') ? (fromJson('"' + github.event.schedule + '"').year + 1) : '') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install axios

      - name: Fetch Hari Libur dari Google Calendar
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          node <<'EOF'
          const fs = require('fs');
          const axios = require('axios');

          async function fetchEvents(year) {
            const timeMin = `${year}-01-01T00:00:00Z`;
            const timeMax = `${year}-12-31T23:59:59Z`;
            const calendarId = 'id.indonesian%23holiday@group.v.calendar.google.com';
            const url = `https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events?key=${process.env.GOOGLE_API_KEY}&timeMin=${timeMin}&timeMax=${timeMax}&orderBy=startTime&singleEvents=true`;

            try {
              const { data } = await axios.get(url);
              const items = data.items || [];
              if (items.length === 0) return null;

              const result = items.map(ev => ({
                Keterangan: ev.summary,
                Tanggal: ev.start.date,
              })).sort((a, b) => a.Tanggal.localeCompare(b.Tanggal));

              return result;
            } catch (err) {
              return null;
            }
          }

          const thisYear = new Date().getFullYear();
          const nextYear = thisYear + 1;
          const folder = 'data';
          if (!fs.existsSync(folder)) fs.mkdirSync(folder);

          (async () => {
            const thisData = await fetchEvents(thisYear);
            if (thisData) fs.writeFileSync(`${folder}/${thisYear}.json`, JSON.stringify(thisData, null, 2));

            const nextData = await fetchEvents(nextYear);
            if (nextData && nextData.length > 0) {
              fs.writeFileSync(`${folder}/${nextYear}.json`, JSON.stringify(nextData, null, 2));
              process.exit(0); // Success
            } else {
              // kosong, prediksi nanti di step Python
              fs.writeFileSync(`${folder}/${nextYear}.json`, '');
              process.exit(0);
            }
          })();
          EOF

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install Python dependencies
        run: pip install hijri-converter

      - name: Jalankan Prediksi Jika Tahun Depan Kosong
        run: |
          YEAR=$(date +%Y)
          NEXT=$((YEAR + 1))

          if [ ! -s "data/$NEXT.json" ]; then
            echo "Menjalankan prediksi $NEXT..."
            python .github/workflows/predict_holidays.py $NEXT > data/$NEXT.json
          fi

      - name: Commit dan Push hasil
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add data/*.json
          git diff --cached --quiet || git commit -m "Update hari libur nasional (resmi dan prediksi)"
          git push
