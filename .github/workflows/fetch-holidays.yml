name: Update Hari Libur Nasional

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * 0' # setiap minggu jam 11:00 WIB

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install Python dependencies
      run: |
        pip install hijri-converter ephem

    - name: Update libur dari Google Calendar atau prediksi jika kosong
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        node <<'EOF'
        const fs = require('fs');
        const https = require('https');
        const { execSync } = require('child_process');

        const yearNow = new Date().getFullYear();
        const years = [yearNow, yearNow + 1];

        async function fetchHoliday(year) {
          const timeMin = `${year}-01-01T00:00:00Z`;
          const timeMax = `${year}-12-31T23:59:59Z`;
          const calendarId = 'id.indonesian%23holiday@group.v.calendar.google.com';
          const key = process.env.GOOGLE_API_KEY;
          const url = `https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events?key=${key}&timeMin=${timeMin}&timeMax=${timeMax}&orderBy=startTime&singleEvents=true`;

          const res = await fetch(url);
          const data = await res.json();

          const items = data.items || [];
          if (items.length === 0) {
            console.warn(`âš ï¸ Google Calendar kosong. Membuat tanggal tetap dan prediksi...`);
            execSync(`python3 script/python.py ${year}`);
            return;
          }

          const result = [];
          for (const item of items) {
            const summary = item.summary;
            const startDate = item.start?.date;
            if (!summary || !startDate) continue;

            const map = {
              'Hari Tahun Baru': `Tahun Baru ${year}`,
              'Satu Muharam / Tahun Baru Hijriah': `Tahun Baru Islam ${year - 578} Hijriyah`,
              'Tahun Baru Imlek': `Tahun Baru Imlek ${year + 551} Kongzili`,
              'Hari Raya Waisak': `Hari Raya Waisak ${year + 544}`,
              'Cuti Bersama Tahun Baru Imlek': 'Cuti Imlek',
              'Isra Mikraj Nabi Muhammad': 'Isra Mikraj Nabi Muhammad',
              'Hari Suci Nyepi (Tahun Baru Saka)': 'Nyepi',
              'Cuti Bersama Hari Suci Nyepi (Tahun Baru Saka)': 'Cuti Nyepi',
              'Maulid Nabi Muhammad': 'Maulid Nabi Muhammad',
              'Kenaikan Isa': 'Kenaikan Isa Almasih',
              'Wafat Isa Almasih': 'Wafat Isa Almasih',
              'Ramadan Start': 'Awal Ramadan',
              'Cuti Bersama Idul Fitri': 'Cuti Idul Fitri',
              'Hari Idul Fitri': `Hari Raya Idul Fitri ${year - 579} Hijriyah`,
              'Hari Buruh Internasional / Pekerja': 'Hari Buruh',
              'Hari Lahir Pancasila': 'Hari Pancasila',
              'Cuti Bersama Waisak': 'Cuti Waisak',
              'Idul Adha (Lebaran Haji)': `Hari Raya Idul Adha ${year - 579} Hijriyah`,
              'Hari Proklamasi Kemerdekaan R.I.': `Proklamasi Kemerdekaan Ke-${year - 1945}`,
              'Hari Raya Natal': 'Natal',
              'Cuti Bersama Natal (Hari Tinju)': 'Cuti Natal'
            };

            for (const key in map) {
              if (summary.includes(key)) {
                result.push({ Keterangan: map[key], Tanggal: startDate });
                break;
              }
            }
          }

          if (result.length > 0) {
            const dir = `data`;
            if (!fs.existsSync(dir)) fs.mkdirSync(dir);
            fs.writeFileSync(`${dir}/${year}.json`, JSON.stringify(result, null, 2));
            console.log(`âœ… ${result.length} data disimpan di ${dir}/${year}.json`);
          } else {
            console.warn(`âš ï¸ Tidak ada data cocok. Membuat prediksi...`);
            execSync(`python3 script/python.py ${year}`);
          }
        }

        (async () => {
          for (const y of years) await fetchHoliday(y);
        })();
        EOF

    - name: Commit changes
      run: |
        git config user.name github-actions
        git config user.email github-actions@users.noreply.github.com
        git add data/*.json
        git diff --quiet && git diff --staged --quiet || git commit -m "ðŸ”„ Update data hari libur otomatis"
        git push
